{"id":"CP-08v","title":"Add MQTT support","description":"Add MQTT protocol support to commonplace. Spec will be supplied (TBD).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T21:56:45.192898672Z","created_by":"jes","updated_at":"2025-12-29T00:39:05.428000759Z","closed_at":"2025-12-29T00:39:05.428000759Z","close_reason":"MQTT support implemented with client, edits/sync/commands handlers, and topic routing. Merged in PR #12."}
{"id":"CP-0fy","title":"Sync tool should checkout directory JSON definition as .json file","description":"The sync tool (commonplace-sync) should write the JSON definition of a directory as a file named `.json` in that directory. This would allow users to see and potentially edit the directory's metadata/structure definition alongside the directory contents.","design":"Needs design discussion: What content should be in the .json file? Just metadata, or full fs-root schema? How does editing .json interact with sync? Need specification before implementation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T14:57:56.428338-08:00","updated_at":"2025-12-29T22:37:26.417918062Z","closed_at":"2025-12-29T22:37:26.417918062Z","close_reason":"Sync client now writes fs-root schema to .commonplace.json in synced directories. Updates on server changes via SSE. Merged in PR #26."}
{"id":"CP-0j4","title":"Fix P1: Respect explicit node_id from server schema (PR #4)","description":"From PR #4 Codex review: When the server's FsSchema uses DocEntry.node_id for stable IDs, this should be respected instead of deriving IDs.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:23.072384-08:00","updated_at":"2025-12-26T23:43:14.374964-08:00","closed_at":"2025-12-26T23:43:14.374964-08:00","close_reason":"Already fixed and merged to main. The handle_schema_change function now uses collect_paths_from_entry which extracts explicit node_id from DocEntry and uses it instead of deriving from path. See sync.rs lines 1249-1265 and 1358-1379."}
{"id":"CP-1ba","title":"Fix P1: Use text fs-root or send JSON-compatible updates (PR #4)","description":"From PR #4 Codex review: The fs-root node is created with content_type application/json but the updates being sent may not be JSON-compatible.","design":"Resolved by CP-qmk (PR #9). The push_schema_to_server function now uses create_yjs_map_diff_update which generates Y.Map updates instead of Y.Text updates. This makes the updates JSON-compatible as required by the fs-root node's application/json content type.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:23.464711-08:00","updated_at":"2025-12-27T00:14:06.868523-08:00","closed_at":"2025-12-27T00:14:06.868523-08:00","close_reason":"Resolved by CP-qmk fix - client now applies server CRDT state before making changes, ensuring proper tombstone creation for deletions. Merged in PR #9.","dependencies":[{"issue_id":"CP-1ba","depends_on_id":"CP-qmk","type":"blocks","created_at":"2025-12-26T23:41:34.266588-08:00","created_by":"daemon"}]}
{"id":"CP-3ky","title":"Implement Router Documents (docs/ROUTER.md)","description":"Implement the router document feature as specified in docs/ROUTER.md:\n\n- Add `--router \u003cnode-id\u003e` CLI flag (repeatable)\n- Router documents are JSON with `version`, `nodes`, and `edges` \n- Server subscribes to router document blue port for changes\n- Apply/diff wiring based on router document content\n- Emit `router.error` events on red port for errors\n- Handle node creation hints from `nodes` section\n- Track router-created wires separately from other wires","design":"Implementation approach:\n\n1. New module: src/router/ with:\n   - mod.rs: Module exports\n   - error.rs: RouterError enum for parse/validation/cycle errors\n   - schema.rs: RouterSchema, Edge, NodeSpec, PortType structs with serde\n   - manager.rs: RouterManager that subscribes to router document's blue port\n\n2. CLI: Added --router \u003cnode-id\u003e flag (repeatable) in cli.rs\n\n3. RouterConfig: Added routers: Vec\u003cString\u003e field\n\n4. Initialization: In lib.rs, for each router ID:\n   - Get or create JSON document node\n   - Create RouterManager with registry reference\n   - Start background watcher task\n   - Perform initial wiring\n\n5. Wire management:\n   - RouterManager tracks wires it created (WireKey -\u003e SubscriptionId)\n   - On each reconcile, diffs desired vs current wires\n   - Removes wires no longer declared, adds new ones\n   - Cycle detection handled by registry, emits router.error on failure\n\n6. Error handling:\n   - Parse errors, unsupported version, missing nodes, cycles → router.error event on red port","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-26T18:29:01.089173-08:00","updated_at":"2025-12-26T23:22:36.003263-08:00","closed_at":"2025-12-26T23:22:36.003263-08:00","close_reason":"Router documents feature implemented. Added --router CLI flag, RouterManager, schema validation, wiring management, and error events. Addressed 4 P2 review suggestions. Merged in PR #8."}
{"id":"CP-3ve","title":"Identify and refactor large files into smaller modules","description":"Audit the codebase for files that have grown too large and could benefit from being split into smaller, more focused modules. Look for files with multiple distinct responsibilities that could be separated.","design":"Test coverage now in place (40 tests). Ready for refactoring.\n\nTarget module structure for src/bin/sync.rs split:\n\n1. src/sync/mod.rs - Module root, re-exports\n2. src/sync/urls.rs - URL building functions (encode_node_id, encode_path, normalize_path, build_*_url)\n3. src/sync/yjs.rs - Yjs update creation (create_yjs_text_update, create_yjs_json_update, json_value_to_any)\n4. src/sync/types.rs - Data structures (HeadResponse, EditResponse, ForkResponse, FileEvent, SyncState, etc.)\n5. src/sync/client.rs - HTTP client operations (SyncClient trait + impl)\n6. src/sync/file_sync.rs - File mode sync (run_file_mode, file_watcher_task, upload_task)\n7. src/sync/dir_sync.rs - Directory mode sync (run_directory_mode, directory_watcher_task, handle_schema_change)\n8. src/sync/sse.rs - SSE handling (sse_task, directory_sse_task, handle_server_edit, refresh_from_head)\n\nsrc/bin/sync.rs becomes thin wrapper: just main() + Args parsing, delegates to sync module.\n\nTests move with their functions to respective modules.","status":"closed","priority":3,"issue_type":"chore","created_at":"2025-12-29T13:47:42.244104-08:00","updated_at":"2025-12-30T03:24:24.008280981Z","closed_at":"2025-12-30T03:24:24.008280981Z","close_reason":"Refactored sync.rs into modular structure. Created src/sync/ with urls.rs, yjs.rs, types.rs (implemented) and client.rs, dir_sync.rs, file_sync.rs, sse.rs (placeholders for Phase 2). Added 44 tests. PR #33 merged."}
{"id":"CP-4e9","title":"Sync protocol infinite loop: commit:null parsed as request","design":"When store has no HEAD commit, it responds with {type:head, req:..., commit:null}. The Rust code distinguishes requests (commit:None) from responses (commit:Some). But null deserializes to None, so the store receives its own response and re-handles it as a request, creating an infinite loop. Fix: use distinct message types like head_request vs head_response, or add a direction field.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-30T00:30:17.030876486Z","created_by":"jes","updated_at":"2025-12-30T01:17:06.619813304Z","closed_at":"2025-12-30T01:17:06.619813304Z","close_reason":"Fixed by splitting Head message into Head (request) and HeadResponse (response). Committed in ded73c4."}
{"id":"CP-51t","title":"Verify diff module returns correct summary struct for replace endpoint","design":"The /nodes/:id/replace endpoint needs diff_to_yjs_update to return (update_bytes, DiffSummary) where DiffSummary has inserted, deleted, operations fields. Need to verify this interface exists or add it.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T08:03:48.888669529Z","created_by":"jes","updated_at":"2025-12-29T09:01:47.131481523Z","closed_at":"2025-12-29T09:01:47.131481523Z","close_reason":"Verified: diff module returns DiffResult with update_bytes, update_b64, operation_count, and summary (DiffSummary with chars_inserted, chars_deleted). replace_node endpoint correctly uses all fields."}
{"id":"CP-5af","title":"Telegram messages ↔ file integration","description":"Bidirectional sync between Telegram messages and commonplace documents:\n- Receive Telegram messages as document updates or events\n- Send document content/edits to Telegram chats\n- Subscribe to specific chats/channels\n- Bot or user account authentication\n\nEnables messaging-as-document patterns and chat automation.","design":"OPEN QUESTIONS for implementation:\n1. Bot token or user session auth?\n2. What's the document schema for messages?\n3. Handle message history or just new messages?\n4. Support for media (photos, files) or text only?\n5. Rate limiting and Telegram API compliance?\n6. How to map chats to document paths?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T23:53:18.825068-08:00","updated_at":"2025-12-30T01:45:22.840556932Z","dependencies":[{"issue_id":"CP-5af","depends_on_id":"CP-nno","type":"blocks","created_at":"2025-12-28T23:53:18.82599-08:00","created_by":"daemon"}]}
{"id":"CP-5p5","title":"Investigate B-\u003eA sync not working: file watcher or echo detection issue","design":"Root cause found: Atomic writes break file watcher.\n\nWhen handle_server_edit writes to file, it uses atomic write (temp + rename). On Linux with inotify, this can cause the watcher to lose track of the file because:\n1. Watcher watches original inode\n2. Rename replaces file with new inode\n3. Watcher still watching old (deleted) inode\n4. Subsequent edits to new file not detected\n\nPotential fixes:\n1. Watch parent directory instead of file\n2. Re-register file watcher after each write\n3. Don't use atomic writes (risk: partial writes on crash)\n4. Use inotify IN_MOVED_TO event to re-watch\n\nNeeds implementation to test which approach works best.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T08:18:50.200861401Z","created_by":"jes","updated_at":"2025-12-29T16:02:38.701416395Z","closed_at":"2025-12-29T16:02:38.701416395Z","close_reason":"Fixed inotify file watcher issue by using direct writes instead of atomic (temp+rename). Testing revealed a separate race condition where upload_task can send stale content before server edits are written - needs follow-up fix. PR #21 merged."}
{"id":"CP-80u","title":"Fix P2: Skip wiring when an identical edge already exists (PR #8)","description":"From PR #8 Codex review: The router creates wires based on managed_wires, but if a wiring already exists from an external source (e.g., /nodes/:from/wire/:to), this code will still call wire_* and create a second subscription. Consider checking existing registry wirings before adding.","design":"Added `find_existing_wiring(from, to, port)` method to NodeRegistry. Router manager now checks for existing wires before creating new ones and adopts them into managed_wires if found. Known limitation: Adopted wires skip the router's cycle error emission, but this is safe because external wire creation already performs cycle detection at the registry level.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T23:24:33.186937-08:00","updated_at":"2025-12-27T00:35:45.522329-08:00","closed_at":"2025-12-27T00:35:45.522329-08:00","close_reason":"Skip duplicate wirings implemented. Added find_existing_wiring() to NodeRegistry. Router now checks for existing wires before creating new ones and skips duplicates without claiming ownership (prevents router interference). Merged in PR #10."}
{"id":"CP-8fz","title":"Fix server replay to use node's content type for JSON documents","description":"P1 from PR #6 review: The server's /nodes/:id/head and replace endpoints replay with ContentType::Text, but Y.Map commits need ContentType::Json. When replaying Y.Map commits with Text type, replay.rs returns \"Text root not found\" causing 500 errors.\n\nFix: Update src/api.rs (around lines 460-464) to use the node's actual content type when replaying commits.","design":"Fixed in 3 places:\n\n1. api.rs get_node_head: Now gets content type from the node via DocumentNode downcast instead of hardcoding Text. This allows proper replay of JSON (Y.Map) commits.\n\n2. api.rs replace_content: Now validates content type and returns 415 error for non-text nodes. Replace endpoint only supports text because it uses text-based diffing.\n\n3. sync.rs push_schema_to_server: Simplified to always use edit endpoint with Y.Map updates. This avoids the replace endpoint's text-only limitation.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T18:13:33.205983-08:00","updated_at":"2025-12-26T18:22:55.113026-08:00","closed_at":"2025-12-26T18:22:55.113026-08:00","close_reason":"Fixed server replay to use node's actual content type. GET /nodes/:id/head now works for JSON (Y.Map) documents. Replace endpoint properly rejects non-text content with 415. Merged in PR #7.","labels":["P1","api","bug","yjs"]}
{"id":"CP-8t3","title":"Move HTTP interface to separate binary with MQTT connection","description":"Extract the HTTP interface into a new binary that connects to the document store over MQTT instead of direct access.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T21:56:46.493852588Z","created_by":"jes","updated_at":"2025-12-29T08:45:22.041612098Z","closed_at":"2025-12-29T01:52:01.289555636Z","close_reason":"HTTP/Store split implemented. Two new binaries: commonplace-store (MQTT+persistence) and commonplace-http (stateless HTTP gateway). Fixed P1 issues from codex reviews. Merged in PR #14.","dependencies":[{"issue_id":"CP-8t3","depends_on_id":"CP-08v","type":"blocks","created_at":"2025-12-28T21:57:24.845534402Z","created_by":"daemon"}]}
{"id":"CP-adm","title":"Macaroons for MQTT-layer authorization","description":"Implement macaroon-based authorization enforced at the MQTT layer. Macaroons provide:\n- Delegatable, attenuatable credentials\n- Fine-grained path-based permissions\n- Caveat-based restrictions (time, scope, etc.)\n\nEnforcement at MQTT means all clients (JS sandbox, external processes, CLI, MCP servers) go through the same auth layer.","design":"OPEN QUESTIONS for implementation:\n1. Where is the macaroon root key stored and managed?\n2. What operations require macaroons vs are public?\n3. How are macaroons minted and distributed to clients?\n4. What caveats are needed (time, path prefix, read-only, etc)?\n5. Who enforces - the MQTT broker (plugin?) or commonplace-store?\n6. Do we need a 'mint macaroon' command or API?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.628965-08:00","updated_at":"2025-12-30T01:44:34.551124057Z"}
{"id":"CP-ajb","title":"Add integration tests for MQTT path resolution","design":"Needs design discussion: Requires understanding MQTT broker setup for tests. Current codebase doesn't have MQTT integration tests - would need to add test infrastructure first (mock broker or real broker in tests). Substantial effort beyond just adding test cases.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T08:03:39.396454509Z","created_by":"jes","updated_at":"2025-12-29T09:02:42.47181951Z"}
{"id":"CP-bnv","title":"Add path-based HTTP API endpoints","design":"Needs design discussion: What should the path-based API look like? Options: 1) /files/path/to/file.txt 2) /docs?path=path/to/file.txt 3) Something else. Need to decide URL structure, how to handle URL encoding of paths, and whether to support both path and UUID access on same endpoints.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-29T08:33:32.251084948Z","created_by":"jes","updated_at":"2025-12-29T21:44:24.931689601Z","closed_at":"2025-12-29T21:44:24.931689601Z","close_reason":"Added /files/*path endpoints for path-based HTTP API access. Merged in PR #24."}
{"id":"CP-c1b","title":"Fix P1: Start sync tasks for newly created local files (PR #4)","description":"From PR #4 Codex review: In directory mode, create/modify events only trigger a schema update but don't start sync tasks for the new files.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.87906-08:00","updated_at":"2025-12-26T23:43:55.607923-08:00","closed_at":"2025-12-26T23:43:55.607923-08:00","close_reason":"Already fixed and merged to main. The DirEvent::Created handler in directory_watcher_task (sync.rs lines 805-828) now calls spawn_file_sync_tasks for newly created local files."}
{"id":"CP-ce1","title":"Implement .processes.json discovery for conductor","description":"Conductor discovers .processes.json files in the document tree and automatically launches/manages declared processes. Enables user-defined processes to attach to file paths without central configuration.\n\nSee: docs/plans/2025-12-30-processes-json-design.md\n\nTasks:\n- Parse .processes.json format (command, owns, cwd)\n- Watch document tree for .processes.json changes\n- Launch processes with COMMONPLACE_PATH and COMMONPLACE_MQTT env vars\n- Restart with exponential backoff on failure\n- Handle conflicts (warn if two processes claim same path)\n- Update counter example to use this convention","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-30T04:17:59.60264365Z","created_by":"jes","updated_at":"2025-12-30T04:56:47.832163772Z","closed_at":"2025-12-30T04:56:47.832163772Z","close_reason":"Implemented .processes.json discovery for conductor. Created discovery.rs with config parsing and process manager. Updated counter example to use env vars. PR #35 merged."}
{"id":"CP-cgi","title":"Fix P1: Use JSON replay when pushing Y.Map schema updates (PR #6)","description":"From PR #6 Codex review: The change switches the initial fs-root schema write to a Y.Map update but needs to use JSON replay instead for proper handling.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.54461-08:00","updated_at":"2025-12-26T23:39:41.921295-08:00","closed_at":"2025-12-26T23:39:41.921295-08:00","close_reason":"Already fixed in PR #7 (CP-8fz: Fix server replay to use node's content type). The replay.rs now handles ContentType::Json by initializing a map root and serializing via map.to_json(). Merged to main."}
{"id":"CP-ckt","title":"Fix P1: URL-encode derived node IDs for nested files (PR #4)","description":"From PR #4 Codex review: When syncing directories, file.relative_path will include / characters which need to be URL-encoded for node IDs.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:22.662002-08:00","updated_at":"2025-12-26T23:42:34.654703-08:00","closed_at":"2025-12-26T23:42:34.654703-08:00","close_reason":"Already fixed in PR #4 (043d0c2). The encode_node_id function was added to URL-encode node IDs containing slashes. All node ID usages in sync.rs now use this function. Merged to main."}
{"id":"CP-cv9","title":"Validate at_commit CID belongs to requested document (P2 from codex review)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-30T06:23:26.603794724Z","created_by":"jes","updated_at":"2025-12-30T06:23:26.603794724Z","labels":["api","security"],"comments":[{"id":2,"issue_id":"CP-cv9","author":"jes","text":"From codex review on PR #36 (src/api.rs:410):\n\nThe ?at_commit path replays commits solely by CID without verifying that the CID is part of the requested document's history. CommitReplayer::get_content_and_state_at_commit ignores the provided doc id, so a caller who knows a CID from another document can fetch that other document's state through /docs/:id/head?at_commit=... (or get misinterpreted content if content types differ).\n\nFix: Check that target_cid is reachable from the document head before replaying.","created_at":"2025-12-30T06:23:35Z"}]}
{"id":"CP-dgu","title":"Sync tool: persist state locally for offline change detection","description":"The sync tool currently has no local state persistence. On restart, it fetches HEAD from the server and may overwrite local changes made while sync was stopped.\n\n## Current Behavior\n- SyncState is purely in-memory (last_written_cid, last_written_content)\n- On startup, fetches server HEAD and writes to local file\n- --initial-sync flag offers limited control (skip/local/server) but no conflict detection\n- Local changes made while offline could be silently lost\n\n## Proposed Solution\nPersist sync state to a local file (e.g., .commonplace-sync.json or alongside each synced file):\n- Last synced CID\n- Last synced content hash\n- Timestamp of last sync\n\nOn restart:\n1. Load persisted state\n2. Compare local file hash to persisted hash → detect local modifications\n3. Fetch server HEAD → detect server modifications  \n4. If both modified: conflict (prompt user or use strategy flag)\n5. If only local modified: push to server\n6. If only server modified: pull to local\n7. If neither modified: resume normal sync\n\n## Files to modify\n- src/bin/sync.rs - Add state persistence and conflict detection\n- Possibly src/sync/ modules for shared types","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-30T05:08:27.003489287Z","created_by":"jes","updated_at":"2025-12-30T05:08:27.003489287Z","comments":[{"id":1,"issue_id":"CP-dgu","author":"jes","text":"Design complete: docs/plans/2025-01-02-sync-state-persistence-design.md\n\nKey design decisions:\n- State file: .{basename}.commonplace-sync.json beside synced target (not inside)\n- Uses CRDT merge instead of manual conflict resolution\n- Stores last_synced_cid + file hashes, not content\n\nBLOCKING: Need to add ?at_commit query param to /head endpoint first (infrastructure exists via CommitReplayer, just not exposed)","created_at":"2025-12-30T05:45:25Z"}]}
{"id":"CP-egb","title":"Sandboxed JS evaluator with document subscriptions and output","description":"Run a JS file in a sandbox with the ability to:\n- Declare dependencies on other commonplace documents\n- Subscribe to commits on those dependencies\n- Create a read-only output document\n- Listen for commands on the output document's path\n- Emit events as that document\n\nThe JS file acts as a reactive transform: inputs → computation → output document.","design":"OPEN QUESTIONS for implementation:\n1. What JS runtime to use (Deno, quickjs, deno_core)?\n2. What APIs are exposed to JS (document, subscribe, emit)?\n3. How to declare dependencies - in JS code or metadata file?\n4. How to limit resource usage (memory, CPU, network)?\n5. Where does the JS file live - in commonplace doc or filesystem?\n6. How to handle errors and crashes - restart policy?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.433243-08:00","updated_at":"2025-12-30T01:45:22.787863201Z","dependencies":[{"issue_id":"CP-egb","depends_on_id":"CP-nno","type":"blocks","created_at":"2025-12-28T22:50:33.552787-08:00","created_by":"daemon"}]}
{"id":"CP-eyi","title":"Cron-style recurring scheduled events","description":"Fire events on a recurring schedule (like crontab). Use cases:\n- Periodic document refresh triggers\n- Scheduled backup/export jobs\n- Regular polling of external sources\n- Time-based workflow triggers\n\nCould be defined as a special node type or as a configuration on documents.","design":"OPEN QUESTIONS for implementation:\n1. Where are schedules stored - in a special document, node metadata, or separate config?\n2. What format for cron expressions (standard cron or extended)?\n3. What event type is fired on schedule trigger?\n4. How to handle timezone - UTC only or configurable?\n5. Should missed events (server was down) be replayed or skipped?\n6. Is this a separate service or integrated into commonplace-store?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T23:53:18.565001-08:00","updated_at":"2025-12-30T01:44:47.450426047Z"}
{"id":"CP-hm9","title":"MCP server: Keep MQTT event loop alive until publish is delivered","design":"From Codex review on PR #31: The event loop is capped at 2 seconds, so if broker connection takes longer, the publish() call only enqueues the packet and the loop stops before it can be sent/acked. fire_command returns success even if command was not delivered. Consider keeping a persistent MQTT client or waiting for ConnAck/PubAck before reporting success. File: src/bin/mcp.rs:73","status":"open","priority":3,"issue_type":"bug","created_at":"2025-12-30T02:22:36.905947547Z","created_by":"jes","updated_at":"2025-12-30T02:22:43.66815698Z"}
{"id":"CP-jnf","title":"Support JSON files as Yjs map/array types in directory sync","description":"Summary: Allow synced JSON files to be stored as Yjs map/array types (not plain text) so JSON structure is preserved in CRDT.\n\nFiles to modify:\n- src/document.rs (content type handling / default doc type)\n- src/diff.rs (JSON diff generation if needed)\n- src/bin/sync.rs (JSON file handling, initial sync)\n- src/sync/content_type.rs (content type mapping, potentially new metadata)\n- docs/FILESYSTEM.md (clarify JSON type behavior)\n- docs/WIRING_DIAGRAM_FILES.md (if wiring files need special handling)\n\nImplementation steps:\n1. Identify how JSON documents are represented in yrs (map/array) vs text and how current commits are applied.\n2. Decide on encoding for JSON files in sync (map vs array based on top-level JSON).\n3. Update sync upload/replace logic to send JSON updates rather than text edits for JSON files.\n4. Ensure server-side content retrieval returns serialized JSON for map/array docs.\n5. Add tests/fixtures for JSON map/array round-trips through sync.\n\nExample:\n- Before: file data.json stored as plain text in Yjs text.\n- After: data.json stored as Yjs map or array (based on top-level JSON), serialized to JSON text on read/write.\n","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T13:28:50.035996-08:00","updated_at":"2025-12-28T14:00:59.660408-08:00","closed_at":"2025-12-28T14:00:59.660408-08:00","close_reason":"Implemented JSON map/array sync support"}
{"id":"CP-ksf","title":"CLI tool for firing commands to commonplace paths","description":"A command-line tool that sends commands to a specified commonplace document path. Allows scripting and manual interaction with commonplace documents via their red port (events/commands).","design":"Needs design discussion: High-level feature request without implementation details. Requires specification of API design, data model, and integration points before implementation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.268771-08:00","updated_at":"2025-12-29T23:50:06.348786945Z","closed_at":"2025-12-29T23:50:06.348786945Z","close_reason":"commonplace-cmd CLI implemented. Merged in PR #28."}
{"id":"CP-lav","title":"Python client: y_py YDoc not thread-safe with paho-mqtt callbacks","design":"The y_py (Yjs Python bindings) YDoc panics when accessed from a different thread than where it was created. paho-mqtt runs message callbacks in a background thread. When command handlers try to publish_edit(), they access YDoc from the MQTT thread, causing panic. Fix options: 1) Use queue to dispatch updates from MQTT thread to main thread, 2) Create YDoc in MQTT thread, 3) Use asyncio-based MQTT client with single-threaded event loop.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-30T00:30:34.203735202Z","created_by":"jes","updated_at":"2025-12-30T01:17:06.747552054Z","closed_at":"2025-12-30T01:17:06.747552054Z","close_reason":"Fixed by implementing queue-based pattern for YDoc operations. MQTT callbacks queue work, main loop processes. Committed in ded73c4."}
{"id":"CP-li3","title":"Deprecate wiring diagram concept","description":"The wiring diagram concept should be deprecated and removed from the codebase.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T21:56:44.059396274Z","created_by":"jes","updated_at":"2025-12-29T08:56:46.462777465Z","closed_at":"2025-12-29T00:50:28.541758-08:00","close_reason":"PR #18 merged. Deprecated nodes abstraction, restored /nodes HTTP endpoints for sync, renamed /sse/nodes to /sse/docs, fixed fs-root ContentType. Follow-up issues filed: CP-bnv (path-based API), CP-pta (nodes→docs rename), CP-m2g (sync path-based)."}
{"id":"CP-lzb","title":"Fix P1: Start sync tasks for files created from server schema (PR #4)","description":"From PR #4 Codex review: When a new path appears in the server schema, the handler doesn't start sync tasks for the new files.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:22.281537-08:00","updated_at":"2025-12-26T23:43:55.692683-08:00","closed_at":"2025-12-26T23:43:55.692683-08:00","close_reason":"Already fixed and merged to main. The handle_schema_change function now takes a spawn_tasks parameter, and runtime SSE events (line 1186) pass spawn_tasks=true to spawn sync tasks for new server-created files."}
{"id":"CP-m2g","title":"Convert sync client to use path-based API","design":"Once path-based HTTP APIs exist (CP-bnv), update commonplace-sync to use paths like /files/notes/todo.txt instead of requiring UUIDs. This would simplify the sync client - no need to create nodes or track UUIDs, just sync files by their natural paths.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-29T08:35:40.683147536Z","created_by":"jes","updated_at":"2025-12-29T22:21:03.49437558Z","closed_at":"2025-12-29T22:21:03.49437558Z","close_reason":"Added --use-paths flag to sync client for path-based API. URL builders select between /files/*path and /docs/:id routes with proper path encoding. Merged in PR #25.","dependencies":[{"issue_id":"CP-m2g","depends_on_id":"CP-bnv","type":"blocks","created_at":"2025-12-29T08:35:57.462826032Z","created_by":"daemon"},{"issue_id":"CP-m2g","depends_on_id":"CP-pta","type":"blocks","created_at":"2025-12-29T08:37:30.460677237Z","created_by":"daemon"}]}
{"id":"CP-nno","title":"External process MQTT client as first-class citizen","description":"Allow a separate Unix process to connect to MQTT and perform all the same actions as the JS sandbox evaluator:\n- Subscribe to document commits\n- Create/own output documents\n- Receive commands on owned document paths\n- Emit events as owned documents\n\nThis makes external processes (any language) first-class participants in the commonplace reactive graph, using MQTT as the protocol.","design":"Needs design discussion: High-level feature request without implementation details. Requires specification of API design, data model, and integration points before implementation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.52436-08:00","updated_at":"2025-12-30T01:26:42.019335953Z","closed_at":"2025-12-30T01:26:42.019335953Z","close_reason":"Python client example complete with FileProcess base class and CounterExample. Bug fixes for sync protocol and thread safety merged in 00fa478."}
{"id":"CP-o2h","title":"Evaluate whether NodeRegistry is still needed after HTTP/store split","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:52:45.145726221Z","created_by":"jes","updated_at":"2025-12-29T04:12:26.221158382Z","closed_at":"2025-12-29T04:12:26.221158382Z","close_reason":"Evaluated: NodeRegistry is NOT duplicated after HTTP/store split. Store owns it (document state, wiring, fs reconciliation). HTTP is stateless (MQTT gateway only). Architecture is already optimal - no changes needed.","dependencies":[{"issue_id":"CP-o2h","depends_on_id":"CP-8t3","type":"blocks","created_at":"2025-12-29T00:52:52.493729194Z","created_by":"daemon"}]}
{"id":"CP-oji","title":"Handle rename events so new paths get sync tasks","description":"notify reports renames as `Modify(Name)` events; the current mapping treats all `is_modify()` as `DirEvent::Modified`. The modified handler only re-pushes schema and never starts new per-file sync tasks or removes old ones, so a rename leaves the new file untracked and the old path's tasks running until restart.\n\nConsider handling rename explicitly (or treating `Modify(Name)` as delete+create).","design":"Implemented by detecting `Modify(Name)` events separately from other modifications in the directory watcher. Rename events are now classified as delete+create based on RenameMode: From→Deleted, To→Created, Both/Any/Other→check path.exists() to determine direction. This ensures sync tasks are properly stopped for old paths and started for new paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:03:59.632881-08:00","updated_at":"2025-12-26T17:49:57.531409-08:00","closed_at":"2025-12-26T17:49:57.531409-08:00","close_reason":"Rename events now handled properly - Modify(Name) events are classified as delete+create based on RenameMode. Merged in PR #5.","labels":["enhancement","sync"]}
{"id":"CP-okn","title":"New orchestrator binary for process management","description":"Create a new orchestrator binary which invokes the document store and (once they exist) other processes like HTTP interface and sandboxed evaluator.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T21:56:47.418639497Z","created_by":"jes","updated_at":"2025-12-29T08:45:22.029787664Z","closed_at":"2025-12-29T03:12:03.336139764Z","close_reason":"Orchestrator binary implemented with process supervision, dependency ordering, restart policies with exponential backoff, and graceful shutdown. Merged in PR #16.","dependencies":[{"issue_id":"CP-okn","depends_on_id":"CP-8t3","type":"blocks","created_at":"2025-12-28T21:57:25.7353176Z","created_by":"daemon"}]}
{"id":"CP-pgx","title":"MCP server for firing commands to commonplace paths","description":"An MCP server that exposes commonplace document paths as callable tools. MCP clients can invoke commands on commonplace documents, bridging LLM tool-use with the commonplace reactive document system.","design":"Needs design discussion: High-level feature request without implementation details. Requires specification of API design, data model, and integration points before implementation.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.349217-08:00","updated_at":"2025-12-30T01:43:40.761417202Z","closed_at":"2025-12-30T01:43:40.761417202Z","close_reason":"Implemented commonplace-mcp server. PR #31 created - pending merge.","dependencies":[{"issue_id":"CP-pgx","depends_on_id":"CP-ksf","type":"related","created_at":"2025-12-28T22:50:33.586139-08:00","created_by":"daemon"}]}
{"id":"CP-pta","title":"Rename /nodes API to /docs throughout codebase","design":"Completed implementation. PR #20 created. Waiting for merge.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T08:37:04.362222409Z","created_by":"jes","updated_at":"2025-12-29T09:40:55.11574492Z","closed_at":"2025-12-29T09:40:55.11574492Z","close_reason":"Renamed /nodes API to /docs throughout codebase. Merged all node endpoints into document API. PR #20 merged."}
{"id":"CP-qmk","title":"Fix P1: Preserve schema deletions when pushing updates (PR #7)","description":"From PR #7 Codex review: When pushing schema updates, deletions are not being preserved. The code always posts an edit built by create_yjs_map_update but this may not handle entry deletions properly. Need to investigate and fix.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.270524-08:00","updated_at":"2025-12-27T00:14:06.786038-08:00","closed_at":"2025-12-27T00:14:06.786038-08:00","close_reason":"Preserve schema deletions implemented. Added state field to HEAD response, client now applies server CRDT state before making changes so deletions create proper tombstones. Merged in PR #9."}
{"id":"CP-qyj","title":"TypeScript support for sandboxed evaluator","description":"Extend the JS sandbox evaluator to support TypeScript. This could mean:\n- Transpiling TS → JS before evaluation\n- Supporting .ts file extensions in sandbox\n- Type definitions for the sandbox API (dependencies, output documents, events)\n\nThis makes the sandbox more ergonomic for larger/complex reactive transforms.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T23:53:18.488271-08:00","updated_at":"2025-12-28T23:53:18.488271-08:00","dependencies":[{"issue_id":"CP-qyj","depends_on_id":"CP-egb","type":"blocks","created_at":"2025-12-28T23:53:18.489746-08:00","created_by":"daemon"}]}
{"id":"CP-r2a","title":"Fix sync race condition: upload_task sends stale content during B-\u003eA sync","description":"When a server edit arrives via SSE, the handle_server_edit function fetches HEAD and writes to the local file. However, the file watcher can trigger upload_task with stale file content before the write completes, causing the old content to be synced back to the server.\n\nRoot cause: Echo detection relies on comparing file content to last_written_content, but there's a window between SSE notification and file write where upload_task can read stale content.\n\nPossible fixes:\n1. Add a flag to pause upload_task during server writes\n2. Use file modification timestamp comparison\n3. Add sequence numbers to track edit origin","design":"## Extended Barrier Pattern - REVISED AFTER CODEX REVIEW\n\n### Codex-Identified Issues:\n\n**CRITICAL: Partial writes can still trigger uploads**\nIf watcher fires during our write, content differs from pending, we upload partial/corrupted content. FIX: Don't immediately upload on mismatch - retry/re-read until content stabilizes or matches pending.\n\n**HIGH: Multiple server edits clobber pending fields**\nIf handle_server_edit runs while barrier is up, it overwrites pending_write_*, causing misclassification when first write's watcher event arrives. FIX: Use generation token (monotonic write_id) so barrier maps to exact write.\n\n**HIGH: Upload with stale parent_cid may fail**\nServer's replace endpoint may reject if parent doesn't match HEAD. FIX: Refresh HEAD before upload, or use CRDT edit endpoint for merges.\n\n**MEDIUM: Window between re-check and barrier set**\nLocal edit can slip in between re-check and write_in_progress=true. FIX: Do both atomically under write lock.\n\n**MEDIUM: Read→drop→write lock pattern is risky**\nState can change between drop(read) and acquire(write). FIX: Re-check under write lock, or use single write lock.\n\n**LOW: Watcher never fires leaves barrier stuck**\nlast_written_cid never updates, next upload uses stale parent. FIX: Timeout/fallback to finalize barrier.\n\n---\n\n### Improved Design: Token-Based Barrier\n\n```rust\nstruct SyncState {\n    last_written_cid: Option\u003cString\u003e,\n    last_written_content: String,\n    // Token-based barrier:\n    current_write_id: u64,  // Monotonic counter\n    pending_write: Option\u003cPendingWrite\u003e,\n}\n\nstruct PendingWrite {\n    write_id: u64,\n    content: String,\n    cid: String,\n    started_at: Instant,\n}\n```\n\n**handle_server_edit:**\n1. Acquire write lock\n2. If pending_write exists and not timed out, queue/skip this edit\n3. Increment current_write_id\n4. Set pending_write = Some(PendingWrite { write_id, content, cid, started_at })\n5. Release lock\n6. Write file\n7. Do NOT clear barrier (upload_task does it)\n\n**upload_task:**\n1. Read file content\n2. Acquire write lock (not read!)\n3. If pending_write exists:\n   a. If content == pending.content AND file stable (re-read matches):\n      - Clear pending, update last_written_*, done (echo)\n   b. If content != pending.content:\n      - Re-read file after short delay (50ms)\n      - If still differs after N retries: user edited, clear pending, upload\n   c. If pending.started_at \u003e 30s ago: timeout, clear pending\n4. Normal echo detection if no pending\n\n**Key improvements:**\n- Retry on mismatch instead of immediate upload (avoids partial writes)\n- Token prevents clobbering from concurrent server edits\n- Single write lock avoids ABA bugs\n- Timeout prevents stuck barrier\n- Refresh HEAD before upload on conflict path","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T16:02:47.797530633Z","created_by":"jes","updated_at":"2025-12-29T20:50:11.443695514Z","closed_at":"2025-12-29T20:50:11.443695514Z","close_reason":"Token-based write barrier implemented to fix sync race condition. Prevents upload_task from sending stale content during server-to-local sync. 13+ codex review iterations, all P1 issues fixed. Merged in PR #23."}
{"id":"CP-se0","title":"One-time scheduled events (at-style)","description":"Schedule events to fire at a specific point in the future. Unlike cron (recurring), these are one-shot:\n- Reminders\n- Delayed actions\n- Future-dated triggers\n- Timeout/deadline events\n\nCould share infrastructure with cron scheduling but with single-fire semantics.","design":"OPEN QUESTIONS for implementation:\n1. How to persist scheduled events across restarts?\n2. What happens if target path doesn't exist when event fires?\n3. Should there be a 'list scheduled events' API?\n4. Can events be cancelled before they fire?\n5. What precision - seconds, milliseconds, or just minutes?\n6. Same storage and service questions as CP-eyi","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T23:53:18.644504-08:00","updated_at":"2025-12-30T01:44:47.476156216Z","dependencies":[{"issue_id":"CP-se0","depends_on_id":"CP-eyi","type":"related","created_at":"2025-12-28T23:53:29.351623-08:00","created_by":"daemon"}]}
{"id":"CP-uj2","title":"Represent directory trees as Yjs JSON (Y.Map) instead of text JSON","description":"Currently, the fs-root document uses TEXT content type with JSON stored as a text string. This was a workaround because the edit system (diff.rs, replay.rs) uses TEXT-based Yjs updates (Y.Text), but DocumentNode for JSON type uses Y.Map internally.\n\nThe proper solution would be to use native Yjs JSON structure (Y.Map) for directory schemas, which would enable:\n- Proper CRDT merging of concurrent schema changes\n- More efficient updates (only changed entries, not full document replacement)\n- Better conflict resolution for concurrent file additions/deletions","design":"Implemented Y.Map support:\n\n1. replay.rs: Extended get_content_and_state_at_commit to support JSON content type by initializing Y.Map root and using map.to_json() for extraction.\n\n2. sync.rs: Added create_yjs_map_update() and json_value_to_any() helper to convert JSON strings to Y.Map updates. Updated push_schema_to_server to use Y.Map updates for initial schema push.\n\nThis enables proper CRDT merging of concurrent schema changes and more efficient updates (only changed entries, not full document replacement).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-26T17:04:59.967959-08:00","updated_at":"2025-12-26T18:01:42.374357-08:00","closed_at":"2025-12-26T18:01:42.374357-08:00","close_reason":"Added Y.Map support for directory schemas: replay.rs now supports JSON content type, sync.rs uses Y.Map updates for initial schema push. Merged in PR #6.","labels":["architecture","sync","yjs"]}
{"id":"CP-y9l","title":"tmux ↔ file integration","description":"Bidirectional sync between tmux pane content and commonplace documents:\n- Capture tmux pane content to a document (scrollback, current view)\n- Send content from a document to a tmux pane (sendkeys)\n- Subscribe to pane output as a stream\n- Control tmux sessions/windows/panes via document commands\n\nEnables terminal-as-document patterns and terminal automation.","design":"OPEN QUESTIONS for implementation:\n1. Use tmux command-line or libtmux/tmux control mode?\n2. What's the document schema for pane content?\n3. How often to capture pane content (poll vs events)?\n4. How to identify target pane (session:window.pane)?\n5. Handle scrollback or just visible content?\n6. Security - limit which sessions can be controlled?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T23:53:18.734354-08:00","updated_at":"2025-12-30T01:45:22.817292165Z","dependencies":[{"issue_id":"CP-y9l","depends_on_id":"CP-nno","type":"blocks","created_at":"2025-12-28T23:53:18.735182-08:00","created_by":"daemon"}]}
{"id":"CP-ylp","title":"Enforce mandatory file extensions in filesystem sync","description":"Update commonplace filesystem so that file extensions are mandatory. Only .json, .txt, .xml, .xhtml, and .bin files can be synced, and they must correspond to their Yjs implementations.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T21:56:43.205364505Z","created_by":"jes","updated_at":"2025-12-28T23:14:28.396705982Z","closed_at":"2025-12-28T23:14:28.396705982Z","close_reason":"Implemented mandatory file extension filtering for filesystem sync. Only .json, .txt, .xml, .xhtml, .bin, .md files are now synced. Added is_allowed_extension() function and filtering in scan_dir_recursive(), scan_files_recursive(), DirEvent::Created handler, and handle_schema_change(). Merged in PR #12."}
{"id":"CP-z7t","title":"MCP server using commonplace JSON file for tool/resource definitions","description":"An MCP server that reads a specified commonplace JSON document and exposes its contents as MCP tools, resources, and prompts. The JSON document defines the MCP schema, and the server dynamically serves those definitions to MCP clients.","design":"OPEN QUESTIONS for implementation:\n1. What JSON schema should define tools? MCP-native schema or custom format?\n2. Should this dynamically reload when the document changes?\n3. How to handle tool implementations - call external commands, evaluate JS, or just return content?\n4. Should it support resources and prompts in addition to tools?\n5. How does this relate to CP-pgx (already implemented) - replace or complement it?","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T22:49:01.180475-08:00","updated_at":"2025-12-30T01:44:22.367660722Z"}
