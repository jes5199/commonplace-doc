{"id":"CP-0fy","title":"Sync tool should checkout directory JSON definition as .json file","description":"The sync tool (commonplace-sync) should write the JSON definition of a directory as a file named `.json` in that directory. This would allow users to see and potentially edit the directory's metadata/structure definition alongside the directory contents.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-28T14:57:56.428338-08:00","updated_at":"2025-12-28T14:57:56.428338-08:00"}
{"id":"CP-0j4","title":"Fix P1: Respect explicit node_id from server schema (PR #4)","description":"From PR #4 Codex review: When the server's FsSchema uses DocEntry.node_id for stable IDs, this should be respected instead of deriving IDs.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:23.072384-08:00","updated_at":"2025-12-26T23:43:14.374964-08:00","closed_at":"2025-12-26T23:43:14.374964-08:00","close_reason":"Already fixed and merged to main. The handle_schema_change function now uses collect_paths_from_entry which extracts explicit node_id from DocEntry and uses it instead of deriving from path. See sync.rs lines 1249-1265 and 1358-1379."}
{"id":"CP-1ba","title":"Fix P1: Use text fs-root or send JSON-compatible updates (PR #4)","description":"From PR #4 Codex review: The fs-root node is created with content_type application/json but the updates being sent may not be JSON-compatible.","design":"Resolved by CP-qmk (PR #9). The push_schema_to_server function now uses create_yjs_map_diff_update which generates Y.Map updates instead of Y.Text updates. This makes the updates JSON-compatible as required by the fs-root node's application/json content type.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:23.464711-08:00","updated_at":"2025-12-27T00:14:06.868523-08:00","closed_at":"2025-12-27T00:14:06.868523-08:00","close_reason":"Resolved by CP-qmk fix - client now applies server CRDT state before making changes, ensuring proper tombstone creation for deletions. Merged in PR #9.","dependencies":[{"issue_id":"CP-1ba","depends_on_id":"CP-qmk","type":"blocks","created_at":"2025-12-26T23:41:34.266588-08:00","created_by":"daemon"}]}
{"id":"CP-3ky","title":"Implement Router Documents (docs/ROUTER.md)","description":"Implement the router document feature as specified in docs/ROUTER.md:\n\n- Add `--router \u003cnode-id\u003e` CLI flag (repeatable)\n- Router documents are JSON with `version`, `nodes`, and `edges` \n- Server subscribes to router document blue port for changes\n- Apply/diff wiring based on router document content\n- Emit `router.error` events on red port for errors\n- Handle node creation hints from `nodes` section\n- Track router-created wires separately from other wires","design":"Implementation approach:\n\n1. New module: src/router/ with:\n   - mod.rs: Module exports\n   - error.rs: RouterError enum for parse/validation/cycle errors\n   - schema.rs: RouterSchema, Edge, NodeSpec, PortType structs with serde\n   - manager.rs: RouterManager that subscribes to router document's blue port\n\n2. CLI: Added --router \u003cnode-id\u003e flag (repeatable) in cli.rs\n\n3. RouterConfig: Added routers: Vec\u003cString\u003e field\n\n4. Initialization: In lib.rs, for each router ID:\n   - Get or create JSON document node\n   - Create RouterManager with registry reference\n   - Start background watcher task\n   - Perform initial wiring\n\n5. Wire management:\n   - RouterManager tracks wires it created (WireKey -\u003e SubscriptionId)\n   - On each reconcile, diffs desired vs current wires\n   - Removes wires no longer declared, adds new ones\n   - Cycle detection handled by registry, emits router.error on failure\n\n6. Error handling:\n   - Parse errors, unsupported version, missing nodes, cycles → router.error event on red port","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-26T18:29:01.089173-08:00","updated_at":"2025-12-26T23:22:36.003263-08:00","closed_at":"2025-12-26T23:22:36.003263-08:00","close_reason":"Router documents feature implemented. Added --router CLI flag, RouterManager, schema validation, wiring management, and error events. Addressed 4 P2 review suggestions. Merged in PR #8."}
{"id":"CP-80u","title":"Fix P2: Skip wiring when an identical edge already exists (PR #8)","description":"From PR #8 Codex review: The router creates wires based on managed_wires, but if a wiring already exists from an external source (e.g., /nodes/:from/wire/:to), this code will still call wire_* and create a second subscription. Consider checking existing registry wirings before adding.","design":"Added `find_existing_wiring(from, to, port)` method to NodeRegistry. Router manager now checks for existing wires before creating new ones and adopts them into managed_wires if found. Known limitation: Adopted wires skip the router's cycle error emission, but this is safe because external wire creation already performs cycle detection at the registry level.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T23:24:33.186937-08:00","updated_at":"2025-12-27T00:35:45.522329-08:00","closed_at":"2025-12-27T00:35:45.522329-08:00","close_reason":"Skip duplicate wirings implemented. Added find_existing_wiring() to NodeRegistry. Router now checks for existing wires before creating new ones and skips duplicates without claiming ownership (prevents router interference). Merged in PR #10."}
{"id":"CP-8fz","title":"Fix server replay to use node's content type for JSON documents","description":"P1 from PR #6 review: The server's /nodes/:id/head and replace endpoints replay with ContentType::Text, but Y.Map commits need ContentType::Json. When replaying Y.Map commits with Text type, replay.rs returns \"Text root not found\" causing 500 errors.\n\nFix: Update src/api.rs (around lines 460-464) to use the node's actual content type when replaying commits.","design":"Fixed in 3 places:\n\n1. api.rs get_node_head: Now gets content type from the node via DocumentNode downcast instead of hardcoding Text. This allows proper replay of JSON (Y.Map) commits.\n\n2. api.rs replace_content: Now validates content type and returns 415 error for non-text nodes. Replace endpoint only supports text because it uses text-based diffing.\n\n3. sync.rs push_schema_to_server: Simplified to always use edit endpoint with Y.Map updates. This avoids the replace endpoint's text-only limitation.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T18:13:33.205983-08:00","updated_at":"2025-12-26T18:22:55.113026-08:00","closed_at":"2025-12-26T18:22:55.113026-08:00","close_reason":"Fixed server replay to use node's actual content type. GET /nodes/:id/head now works for JSON (Y.Map) documents. Replace endpoint properly rejects non-text content with 415. Merged in PR #7.","labels":["P1","api","bug","yjs"]}
{"id":"CP-c1b","title":"Fix P1: Start sync tasks for newly created local files (PR #4)","description":"From PR #4 Codex review: In directory mode, create/modify events only trigger a schema update but don't start sync tasks for the new files.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.87906-08:00","updated_at":"2025-12-26T23:43:55.607923-08:00","closed_at":"2025-12-26T23:43:55.607923-08:00","close_reason":"Already fixed and merged to main. The DirEvent::Created handler in directory_watcher_task (sync.rs lines 805-828) now calls spawn_file_sync_tasks for newly created local files."}
{"id":"CP-cgi","title":"Fix P1: Use JSON replay when pushing Y.Map schema updates (PR #6)","description":"From PR #6 Codex review: The change switches the initial fs-root schema write to a Y.Map update but needs to use JSON replay instead for proper handling.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.54461-08:00","updated_at":"2025-12-26T23:39:41.921295-08:00","closed_at":"2025-12-26T23:39:41.921295-08:00","close_reason":"Already fixed in PR #7 (CP-8fz: Fix server replay to use node's content type). The replay.rs now handles ContentType::Json by initializing a map root and serializing via map.to_json(). Merged to main."}
{"id":"CP-ckt","title":"Fix P1: URL-encode derived node IDs for nested files (PR #4)","description":"From PR #4 Codex review: When syncing directories, file.relative_path will include / characters which need to be URL-encoded for node IDs.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:22.662002-08:00","updated_at":"2025-12-26T23:42:34.654703-08:00","closed_at":"2025-12-26T23:42:34.654703-08:00","close_reason":"Already fixed in PR #4 (043d0c2). The encode_node_id function was added to URL-encode node IDs containing slashes. All node ID usages in sync.rs now use this function. Merged to main."}
{"id":"CP-jnf","title":"Support JSON files as Yjs map/array types in directory sync","description":"Summary: Allow synced JSON files to be stored as Yjs map/array types (not plain text) so JSON structure is preserved in CRDT.\n\nFiles to modify:\n- src/document.rs (content type handling / default doc type)\n- src/diff.rs (JSON diff generation if needed)\n- src/bin/sync.rs (JSON file handling, initial sync)\n- src/sync/content_type.rs (content type mapping, potentially new metadata)\n- docs/FILESYSTEM.md (clarify JSON type behavior)\n- docs/WIRING_DIAGRAM_FILES.md (if wiring files need special handling)\n\nImplementation steps:\n1. Identify how JSON documents are represented in yrs (map/array) vs text and how current commits are applied.\n2. Decide on encoding for JSON files in sync (map vs array based on top-level JSON).\n3. Update sync upload/replace logic to send JSON updates rather than text edits for JSON files.\n4. Ensure server-side content retrieval returns serialized JSON for map/array docs.\n5. Add tests/fixtures for JSON map/array round-trips through sync.\n\nExample:\n- Before: file data.json stored as plain text in Yjs text.\n- After: data.json stored as Yjs map or array (based on top-level JSON), serialized to JSON text on read/write.\n","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-28T13:28:50.035996-08:00","updated_at":"2025-12-28T14:00:59.660408-08:00","closed_at":"2025-12-28T14:00:59.660408-08:00","close_reason":"Implemented JSON map/array sync support"}
{"id":"CP-lzb","title":"Fix P1: Start sync tasks for files created from server schema (PR #4)","description":"From PR #4 Codex review: When a new path appears in the server schema, the handler doesn't start sync tasks for the new files.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:22.281537-08:00","updated_at":"2025-12-26T23:43:55.692683-08:00","closed_at":"2025-12-26T23:43:55.692683-08:00","close_reason":"Already fixed and merged to main. The handle_schema_change function now takes a spawn_tasks parameter, and runtime SSE events (line 1186) pass spawn_tasks=true to spawn sync tasks for new server-created files."}
{"id":"CP-oji","title":"Handle rename events so new paths get sync tasks","description":"notify reports renames as `Modify(Name)` events; the current mapping treats all `is_modify()` as `DirEvent::Modified`. The modified handler only re-pushes schema and never starts new per-file sync tasks or removes old ones, so a rename leaves the new file untracked and the old path's tasks running until restart.\n\nConsider handling rename explicitly (or treating `Modify(Name)` as delete+create).","design":"Implemented by detecting `Modify(Name)` events separately from other modifications in the directory watcher. Rename events are now classified as delete+create based on RenameMode: From→Deleted, To→Created, Both/Any/Other→check path.exists() to determine direction. This ensures sync tasks are properly stopped for old paths and started for new paths.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-26T17:03:59.632881-08:00","updated_at":"2025-12-26T17:49:57.531409-08:00","closed_at":"2025-12-26T17:49:57.531409-08:00","close_reason":"Rename events now handled properly - Modify(Name) events are classified as delete+create based on RenameMode. Merged in PR #5.","labels":["enhancement","sync"]}
{"id":"CP-qmk","title":"Fix P1: Preserve schema deletions when pushing updates (PR #7)","description":"From PR #7 Codex review: When pushing schema updates, deletions are not being preserved. The code always posts an edit built by create_yjs_map_update but this may not handle entry deletions properly. Need to investigate and fix.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-26T23:24:21.270524-08:00","updated_at":"2025-12-27T00:14:06.786038-08:00","closed_at":"2025-12-27T00:14:06.786038-08:00","close_reason":"Preserve schema deletions implemented. Added state field to HEAD response, client now applies server CRDT state before making changes so deletions create proper tombstones. Merged in PR #9."}
{"id":"CP-uj2","title":"Represent directory trees as Yjs JSON (Y.Map) instead of text JSON","description":"Currently, the fs-root document uses TEXT content type with JSON stored as a text string. This was a workaround because the edit system (diff.rs, replay.rs) uses TEXT-based Yjs updates (Y.Text), but DocumentNode for JSON type uses Y.Map internally.\n\nThe proper solution would be to use native Yjs JSON structure (Y.Map) for directory schemas, which would enable:\n- Proper CRDT merging of concurrent schema changes\n- More efficient updates (only changed entries, not full document replacement)\n- Better conflict resolution for concurrent file additions/deletions","design":"Implemented Y.Map support:\n\n1. replay.rs: Extended get_content_and_state_at_commit to support JSON content type by initializing Y.Map root and using map.to_json() for extraction.\n\n2. sync.rs: Added create_yjs_map_update() and json_value_to_any() helper to convert JSON strings to Y.Map updates. Updated push_schema_to_server to use Y.Map updates for initial schema push.\n\nThis enables proper CRDT merging of concurrent schema changes and more efficient updates (only changed entries, not full document replacement).","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-26T17:04:59.967959-08:00","updated_at":"2025-12-26T18:01:42.374357-08:00","closed_at":"2025-12-26T18:01:42.374357-08:00","close_reason":"Added Y.Map support for directory schemas: replay.rs now supports JSON content type, sync.rs uses Y.Map updates for initial schema push. Merged in PR #6.","labels":["architecture","sync","yjs"]}
